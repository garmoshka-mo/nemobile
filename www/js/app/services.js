services.factory("api",["$http","$q","$upload","notification","storage","$rootScope",function(e,t,n){console.log("api service is enabled");var s={setAccessToken:function(e){this.accessToken=e},clearAccessToken:function(){this.accessToken=null},signin:function(n,s){return e({method:"POST",url:App.Settings.apiUrl+"/login",data:{name:n,password:s}}).then(function(e){return e.data.success?{accessToken:e.data.access_token}:t.reject({errorDescription:e.data.error[1]})})},signup:function(n,s){return e({method:"POST",url:App.Settings.apiUrl+"/register",data:{name:n,password:s}}).then(function(e){return console.log(e),e.data.success?!0:t.reject({errorDescription:e.data.error})})},getUserInfo:function(n){return e({method:"POST",url:App.Settings.apiUrl+"/profile",data:{access_token:n}}).then(function(e){return e.data.success?e.data.user:t.reject()})},getServerTime:function(){return e({method:"GET",url:App.Settings.apiUrl+"//time?access_token="+s.accessToken}).then(function(e){return e.data.origin_time},function(){return t.reject()})},getTimeDifference:function(){return s.getServerTime().then(function(e){var t=1e3*e-(new Date).getTime();return console.log("Difference with server time(msec): ",t),t})},sendMessage:function(t,n,o){return e({method:"POST",url:App.Settings.apiUrl+"/messages",data:{access_token:s.accessToken,recepient_uuid:n,message_text:t,ttl:o}})},searchUser:function(n,o){var i;return i=o?[{phone_number:o}]:[{name:n}],e({method:"POST",url:App.Settings.apiUrl+"/users/search",data:{access_token:s.accessToken,search_params:i}}).then(function(e){return console.log(e),e.data.success?e.data:t.reject()},function(){return t.reject()})},getCategories:function(){return e({method:"GET",url:App.Settings.apiUrl+"/categories?access_token="+s.accessToken}).then(function(e){return e.data.categories},function(){return t.reject()})},addNewCategory:function(t){return e({method:"POST",url:App.Settings.apiUrl+"/categories",data:{access_token:s.accessToken,category:{name:t}}})},removeCategory:function(n){return e({method:"DELETE",url:App.Settings.apiUrl+"/categories/"+n+"?access_token="+s.accessToken}).then(function(e){return console.log(e),e.data.categories},function(){return t.reject()})},updateCategory:function(n,o){return e({method:"PUT",url:App.Settings.apiUrl+"/categories/"+n,data:{access_token:s.accessToken,category:{name:o}}}).then(function(e){console.log(e)},function(){return t.reject()})},addStickerURL:function(n,o){return e({method:"POST",url:App.Settings.apiUrl+"/categories/"+n+"/images",data:{access_token:s.accessToken,id:n,image:{image_url:o}}}).then(function(e){return console.log(e),e.data.categories},function(){return t.reject()})},addStickerFile:function(e,o){var i=t.defer();return fileTypeDeterminer.detect(o,function(t){n.upload({method:"POST",url:App.Settings.apiUrl+"/categories/"+e+"/images",data:{access_token:s.accessToken,id:e},file:o,fileName:"image."+t,fileFormDataName:"image[image_data]"}).then(function(){i.resolve()},function(){i.reject()})},function(){alert("wrong file type")}),i.promise},moveSticker:function(n,o,i){var r=App.Settings.apiUrl+"/categories/"+n+"/images/"+o;return e({method:"PUT",url:r,data:{access_token:s.accessToken,id:n,image_id:o,new_category_id:i}}).then(function(e){console.log(e)},function(){return t.reject()})},removeSticker:function(n,o){var i=App.Settings.apiUrl+"/categories/"+n+"/images/"+o+"?access_token="+s.accessToken;return e({method:"DELETE",url:i}).then(function(e){return console.log(e),e.data.categories},function(){return t.reject()})},initPhoneActivation:function(n){return e({method:"POST",url:App.Settings.apiUrl+"/phone/activation/init",data:{phone_number:n}}).then(function(e){return console.log(e),e.data.success?void 0:t.reject()},function(e){return console.log(e),t.reject()})},confirmPhoneNumber:function(n,o,i){var r={phone_number:n,activation_code:o};return i&&(r.access_token=s.accessToken),e({method:"POST",url:App.Settings.apiUrl+"/phone/activation/confirm",data:r}).then(function(e){return console.log(e.data),e.data.success?e.data:t.reject()},function(e){return console.log(e),t.reject()})},attachPhoneNumber:function(n){return e({method:"POST",url:App.Settings.apiUrl+"/phone/activation/attach",data:{phone_number:n,access_token:s.accessToken}}).then(function(e){return e.data.success?e.data:t.reject(e.data.error)},function(e){return console.log(e),t.reject()})},findNepotomUsers:function(n){return e({method:"POST",url:App.Settings.apiUrl+"/users/phonebook_search",data:{phonebook:n,access_token:s.accessToken}}).then(function(e){return console.log(e.data),e.data.success?e.data:t.reject(e.data.error)},function(e){return console.log(e),t.reject()})},getUserInfoByUuid:function(n){return e({method:"POST",url:App.Settings.apiUrl+"/users",data:{user_uuid:n,access_token:s.accessToken}}).then(function(e){return console.log(e),e.data.success?e.data:t.reject(e.data.error)},function(e){return console.log(e),t.reject()})}};return window.api=s,s}]),services.factory("friendsList",["$rootScope","$q","Friend","storage","api",function(e,t,n,s,o){function i(e){var t=e.length-1,s=+e[t].id;if(console.log(s),console.log(c),s>c.lastContactId){for(var o=[],i=t;i>=0&&e[i].id>c.lastContactId;i--){var a=new n(e[i]);c.friends.push(a),o.push(a)}c.lastContactId=+e[t].id}console.log("user's contacts are exported"),r(o),c.save()}function r(e){var t=[],n={};e&&e.forEach(function(e){e.phoneNumbers&&e.phoneNumbers.forEach(function(s){t.push(s.value),n[s.value]=e})}),o.findNepotomUsers(t).then(function(e){console.log("find nepotom users res:",e);for(var t in e.search_results){var s=e.search_results[t];n[t].setUuid(s),c.nepotomFriends[s]=n[t],console.log("user is added to nepotom friends")}c.save()})}function a(e){console.log(e)}var c={friends:[],nepotomFriends:{},lastContactId:null,clear:function(){this.friends=[],this.nepotomFriends={},this.lastContactId=null},save:function(){s.saveFriendsList(this),console.log("friends list is saved")},addFriend:function(e){var t=new n(e);this.friends.push(t),t.uuid&&(this.nepotomFriends[t.uuid]=t),this.save()},removeFriend:function(e){var t=this.friends.indexOf(e),n=e.uuid,s={};if(-1!==t){this.friends.splice(t,1);for(var o in this.nepotomFriends)o!=n&&(s[o]=this.nepotomFriends[o]);this.nepotomFriends=s}this.save()},getUserContacts:function(){var e=t.defer();return navigator.contacts?navigator.contacts.find(["displayName","phoneNumber"],function(t){e.resolve(i(t))},a,{multiple:!0}):e.reject("contacts is not defined"),e.promise},parseFromStorage:function(e){if(e){var t=this;e.friends.forEach(function(e){var s=new n(e);t.friends.push(s),s.uuid&&(t.nepotomFriends[s.uuid]=s)}),t.lastContactId=e.lastContactId}}};return c}]),services.factory("notification",["$rootScope","$timeout",function(e,t){return console.log("notification service is enabled"),e.notification={},{set:function(t,n){e.notification.text=t,e.notification.handler=function(){n&&n()}},setTemporary:function(n,s,o){var i=this,r=e.notification.text,a=e.notification.handler;e.notification.text=n,e.notification.handler=function(){o&&o()},e.notification.animated=!0,s=s||1e3,t(function(){i.clear(),r&&(a?i.set(r,a):i.set(r))},s)},clear:function(){e.notification.text="",e.notification.animated=!1}}}]),services.service("stickersGallery",["api","$rootScope","$q",function(e,t,n){console.log("stickersGalleryService is enabled");var s=this;this.categories=null,this.isUpdating=!1,this.getCurrentUserCategories=function(){s.isUpdating=!0,e.getCategories().then(function(e){s.isUpdating=!1,s.categories=e,console.log("Stickers gallery is updated")})},this.addNewCategory=function(t){return e.addNewCategory(t).then(function(){s.getCurrentUserCategories()})},this.removeCategory=function(t){return e.removeCategory(t.id).then(function(){s.getCurrentUserCategories()})},this.updateCategory=function(t,n){return e.updateCategory(t,n).then(function(){s.getCurrentUserCategories()})},this.addStickerURL=function(t,n){return e.addStickerURL(t,n).then(function(){s.getCurrentUserCategories()})},this.addStickerFile=function(t,o){return e.addStickerFile(t,o).then(function(){s.getCurrentUserCategories()},function(){return n.reject()})},this.removeSticker=function(t,n){return e.removeSticker(t,n).then(function(){s.getCurrentUserCategories()})},this.moveSticker=function(t,n,o){e.moveSticker(t,n,o).then(function(){s.getCurrentUserCategories()})}}]),window.clearAll=function(){localStorage.clear(),localforage.clear()},services.factory("storage",["$localForage","$timeout",function(e){function t(e,t){var n={};t||(t=[]);for(var s in e)"function"!=typeof e[s]&&-1==t.indexOf(s)&&(n[s]=e[s]);return n}var n={getUser:function(){return e.getItem("user")},getChats:function(){return e.getItem("chats")},getFriends:function(){return e.getItem("friends")},getFriendsList:function(){return e.getItem("friendsList")},getChatSession:function(t,n){var s="chatSession_"+t+"_"+n;return e.getItem(s)},getLastMessageTimestamp:function(){return e.getItem("lastMessageTimestamp")},saveUser:function(n){var s=["chats","friends","friendsList"],o=t(n,s);e.setItem("user",o)},saveFriends:function(t){e.setItem("friends",t).then(function(e){console.log(e)},function(e){console.log(e)})},saveFriendsList:function(n){var s=["nepotomFriends"];e.setItem("friendsList",t(n,s))},saveChats:function(n){var s={},o=["chatSessions","lastUnexpiredChatSession","currentUser"];for(var i in n)s[i]=t(n[i],o);e.setItem("chats",s)},saveChatSession:function(n){var s=["timer","currentChat"],o=t(n,s);e.setItem("chatSession_"+n.senderId+"_"+n.id,o)},saveLastMessageTimestamp:function(t){e.setItem("lastMessageTimestamp",t)},removeChatSession:function(t,n){var s="chatSession_"+t+"_"+n;e.removeItem(s)},clear:function(){localStorage.clear(),e.clear()}};return n}]),services.service("user",["$timeout","storage","Chat","notification","api","$q","$rootScope","$http","stickersGallery","friendsList",function(e,t,n,s,o,i,r,a,c,u){function l(e,t,n){var o;o=e.friendsList.nepotomFriends[n]?e.friendsList.nepotomFriends[n].displayName:"Новое сообщение",s.setTemporary(o+": "+t,4e3,function(){location.href="#/chat?senderId="+n})}function d(e){C.name=e.name,C.channel=e.channel_name,C.uuid=e.uuid,C.scores=e.score,C.phoneNumber=e.phone_number,C.avatar=e.uuid,C.subscribe(C.channel),localStorage.setItem("isLogged",!0),C.save(),C.saveFriends(),f(),c.getCurrentUserCategories(),registerDeviceToChannel()}function f(){o.setAccessToken(C.accessToken)}function g(){C.name=null,C.uuid=null,C.accessToken=null,C.channel=null,C.scores=null,C.friends={},C.chats={},C.lastMessageTimestamp=null,u.clear()}function h(){U.unsubscribe({channel:C.channel})}function p(e){var t=C,n=e.pn_gcm.data.uuid,s=e.pn_gcm.data.message;if("system"===n&&T(C.accessToken),t.chats[n]){console.log("added to existing chat"),t.chats[n].getLastUnexpiredChatSession();var o;t.chats[n].isExpired?(t.chats[n].addChatSession(n,n),t.chats[n].getLastUnexpiredChatSession(),o=t.chats[n].lastUnexpiredChatSession):o=t.chats[n].lastUnexpiredChatSession,o.isReplied||o.creatorId===t.uuid&&o.setReplied(),o.messages.push({text:s,isOwn:!1})}else{console.log("created new chat"),t.addChat(n),t.chats[n].addChatSession(n,n),t.chats[n].getLastUnexpiredChatSession();var o=t.chats[n].lastUnexpiredChatSession;o.messages.push({text:s,isOwn:!1})}t.scores=e.my_score,t.chats[n].senderScores=e.his_score,t.chats[n].isRead=!1,t.lastMessageTimestamp=(new Date).getTime(),t.saveLastMessageTimestamp(),l(t,s,n),o.setTimer(e.expires),o.save(),console.log("When chatSession expires: ",o.whenExipires),console.log("income message",e),console.log(t),r.$apply()}function m(){var e=i.defer();return U.time(function(t){k=t/1e4-(new Date).getTime(),console.log("difference between pubnub and device time: ",k),e.resolve(k)}),e.promise}function v(){C.lastMessageTimestamp&&(console.log("last seen message timestamp * 10000: ",(1e4*C.lastMessageTimestamp).toString()),U.history({channel:C.channel,end:1e4*(C.lastMessageTimestamp+k),callback:function(e){console.log("unseen messages: ",e);for(var t=e[0],n=0;n<t.length;n++)p(t[n]);window.goToLastMessageChat&&(location.href="#/chat?senderId="+t[t.length-1].sender_uuid),window.isGotUnseenMessage=!0}}))}function S(){if(window.deviceId){var e="iOS"===device.platform?"apns":"gcm",t="http://pubsub.pubnub.com/v1/push/sub-key/"+App.Settings.pubnubSubscribeKey+"/devices/"+window.deviceId+"/remove?type="+e;a.get(t).then(function(e){console.log(e)},function(e){console.log(e)})}}function T(e){C.signin(null,null,e),console.log("user info is updated")}this.name=null,this.uuid=null,this.accessToken=null,this.channel=null,this.scores=null,this.chats={},this.lastMessageTimestamp=null,this.friendsList=u;var k,C=this;window.registerDeviceToChannel=function(){if(window.deviceId){var e="iOS"===device.platform?"apns":"gcm",t="http://pubsub.pubnub.com/v1/push/sub-key/"+App.Settings.pubnubSubscribeKey+"/devices/"+window.deviceId+"?add="+C.channel+"&type="+e;a.get(t).then(function(e){console.log("device is registered to user's channel",e)},function(e){console.log("register device error",e)})}else console.error("device id is undefined")},this.signin=function(e,t,n){function s(e){return o.getUserInfo(e).then(function(e){d(e),console.log("user is logged",C)},function(e){return console.error("sign in fail"),i.reject(e)})}var r=this;return n?(r.accessToken=n,s(r.accessToken)):o.signin(e,t).then(function(e){r.accessToken=e.accessToken},function(e){return i.reject(e.errorDescription)}).then(function(){s(r.accessToken)},function(e){return i.reject(e)})},this.signup=function(e,t){return o.signup(e,t).then(function(e){return e},function(e){return i.reject(e.errorDescription)})},this.logout=function(){t.clear(),h(),g(),S(),console.log("user is logged out",C)},this.getUnseenMessages=function(){k?v():m().then(function(){v()})},this.addFriend=function(e,t){var n={name:{formatted:t},uuid:e};u.addFriend(n)},this.addChat=function(e){this.chats[e]=new n(e,this),this.chats[e].updateChatTitle()},this.parseFromStorage=function(){var e=this;t.getUser().then(function(t){e.accessToken=t.accessToken,e.name=t.name,e.uuid=t.uuid,e.channel=t.channel,e.scores=t.scores,e.phoneNumber=t.phoneNumber,e.lastReadMessageTimestamp=t.lastReadMessageTimestamp,e.avatar=t.avatar,e.subscribe(),registerDeviceToChannel(),f(),c.getCurrentUserCategories(),console.log("user info is taken from storage",e)}),t.getChats().then(function(t){var s={};for(var o in t)s[o]=n.parseFromStorage(t[o],e);e.chats=s,console.log("user chats are taken from storage",C.chats)}),t.getLastMessageTimestamp().then(function(t){e.lastMessageTimestamp=t,e.getUnseenMessages()}),t.getFriendsList().then(function(t){u.parseFromStorage(t),e.friendsList=u,console.log("user's friends list is taken from storage")})},this.save=function(){t.saveUser(this),console.log("user info is saved")},this.saveFriends=function(){t.saveFriends(this.friends),console.log("user friends is saved")},this.saveChats=function(){t.saveChats(this.chats),console.log("user chats are saved")},this.saveLastMessageTimestamp=function(){t.saveLastMessageTimestamp(this.lastMessageTimestamp)},this.isLogged=function(){return!!localStorage.getItem("isLogged")},this.subscribe=function(){var e=this;U.subscribe({channel:e.channel,message:function(e){p(e)}})},this.initRegistrationWithPhone=function(e){return o.initPhoneActivation(e)},this.attachPhoneNumber=function(e){return o.attachPhoneNumber(e)},this.confirmPhoneNumber=function(e,t,n){return o.confirmPhoneNumber(e,t,n).then(function(e){T(e.access_token)},function(e){return i.reject(e)})};var U=PUBNUB.init({subscribe_key:App.Settings.pubnubSubscribeKey});this.isLogged()&&(this.parseFromStorage(),console.log("user data is taken from storage"))}]);