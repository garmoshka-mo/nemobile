factories.factory("Chat",["storage","ChatSession","api","$q",function(e,s,t){function i(e,s){this.senderId=e,this.chatSessions={},this.chatSessionsIndexes=[],this.isExpired=!0,this.isReplied=!1,this.lastChatSessionIndex=null,this.lastUnexpiredChatSession=null,this.currentUser=s,this.senderScores=null,this.title=e}return i.parseFromStorage=function(e,s){var t=new i(e.senderId);return t.chatSessionsIndexes=e.chatSessionsIndexes,t.isExpired=e.isExpired,t.lastChatSessionIndex=e.lastChatSessionIndex,t.senderScores=e.senderScores,t.isRead=e.isRead,t.title=e.title,t.currentUser=s,t},i.prototype={addChatSession:function(e,t){var i;i=null===this.lastChatSessionIndex?0:this.lastChatSessionIndex+1,this.lastChatSessionIndex=i;var n=new s(e,t,i,this);this.isExpired=!1,this.chatSessionsIndexes.push(i),this.chatSessions[i]=n,this.lastUnexpiredChatSession=n,this.currentUser.saveChats()},getChatSessionFromStorage:function(t){return e.getChatSession(this.senderId,t).then(function(e){return s.parseFromStorage(e)})},getLastUnexpiredChatSession:function(){var t=!1,i=this;return this.isExpired?!1:(void 0!==this.lastChatSessionIndex&&(this.lastUnexpiredChatSession=this.chatSessions[this.lastChatSessionIndex],t=this.lastUnexpiredChatSession?!0:!1),void(t||e.getChatSession(this.senderId,this.lastChatSessionIndex).then(function(e){if(e){var t=s.parseFromStorage(e,i);i.lastUnexpiredChatSession=t,i.chatSessions[i.lastChatSessionIndex]=t,console.log(i.currentUser)}})))},updateChatTitle:function(){var e=this;e.currentUser.friendsList.nepotomFriends[e.senderId]?e.title=e.currentUser.friendsList.nepotomFriends[e.senderId].displayName:t.getUserInfoByUuid(e.senderId).then(function(s){console.log(s),s.success&&(e.title=s.user.name?s.user.name:s.user.phone_number)},function(){console.error("get chat title error")}),this.currentUser.saveChats()},remove:function(){var e=this.currentUser.chats,s={};for(var t in e)this.senderId!=t&&(s[t]=e[t]);this.currentUser.chats=s,console.log("chat is removed"),this.currentUser.saveChats()},handleExpiredChatSession:function(){this.lastUnexpiredChatSession=null,this.isExpired=!0,console.log("chatSession is sent to archive")},removeLastChatSession:function(){1!==this.chatSessionsIndexes.length||this.isReplied||this.currentUser.friendsList.nepotomFriends[this.senderId]||this.remove(),e.removeChatSession(this.senderId,this.lastChatSessionIndex),this.chatSessionsIndexes.pop(),this.lastUnexpiredChatSession=null,this.isExpired=!0,console.log("chatSession is removed")}},i}]),factories.factory("ChatSession",["$timeout","storage","api","$q",function(e,s,t,i){function n(e,s,t,i){this.isExpired=!1,this.isReplied=!1,this.id=t,this.senderId=s,this.messages=[],this.timer=null,this.creatorId=e,this.currentChat=i,this.whenExipires=1/0}function r(e){var s=(new Date).getTime()+o,t=1e3*e-s;return console.log("time to live(sec): "+t/1e3),t}var o;return n.parseFromStorage=function(s,t){var i=new n(s.creatorId,s.senderId,s.id);i.messages=s.messages,i.isReplied=s.isReplied,i.extraTime=s.extraTime,i.currentChat=t,i.whenExipires=null===s.whenExipires?1/0:s.whenExipires;var r=i.whenExipires-(new Date).getTime();return 0>r?(i.isExpired=!0,e(function(){i.close()},0)):(i.isExpired=!1,i.setTimeout(r)),i},n.prototype={close:function(){this.isExpired=!0,this.isReplied?this.currentChat.handleExpiredChatSession():this.currentChat.removeLastChatSession(),console.warn("chat session expired")},setTimeout:function(s){var t=this;console.log("timer for chatSession is set. Left(msec): "+s),s>2147483647&&(this.extraTime=s-2147483647,s=2147483647,console.log("extra time is added(msec): "+this.extraTime)),this.timer&&e.cancel(this.timer),this.timer=e(function(){return t.extraTime>0?(t.setTimeout(t.extraTime),!1):void t.close()},s)},setTimer:function(e){var i,n=this;o?(i=r(e),n.setTimeout(i),n.whenExipires=(new Date).getTime()+i):t.getTimeDifference().then(function(t){o=t,i=r(e),n.setTimeout(i),n.whenExipires=(new Date).getTime()+i,s.saveChatSession(n)})},setReplied:function(){this.isReplied=!0,this.currentChat.isReplied||(this.currentChat.isReplied=!0)},save:function(){s.saveChatSession(this,this.senderId),console.log("chat session is saved")},getLastMessage:function(){if(this.messages.length){var e=this.messages.length,s=this.messages[e-1].text;if(s.match(/(http|https):/)){var t=["gif","png","jpeg","jpg"],i=s.split("."),n=i[i.length-1];return-1!=t.indexOf(n)?"(image)":"(link)"}return s}},sendMessage:function(e,s,n){var r=this;return t.sendMessage(e,s,n).then(function(s){return console.log("message is sent",s),s.data.success&&!s.data.type?(r.messages.length||(r.creatorId=r.currentChat.currentUser.uuid),r.messages.push({text:e,isOwn:!0}),r.setTimer(s.data.expires),r.save(),console.log("chat session is saved"),!0):i.reject(s.data.type)},function(e){console.error(e)})}},n}]),factories.factory("Friend",["storage","ChatSession",function(){function e(e){e?(e.displayName?this.displayName=e.displayName:e.name&&(this.displayName=e.name.formatted),this.phoneNumbers=e.phoneNumbers,this.photos=e.photos,this.uuid=e.uuid,this.id=e.id):console.error("Friend constructor is called without necessary data")}return e.prototype={setUuid:function(e){this.uuid=e},addPhoneNumber:function(e){this.phoneNumbers.push({value:e})}},e}]);