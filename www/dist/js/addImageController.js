angular.module("angControllers").controller("addImageController",["$scope","$stateParams","stickersGallery","notification",function(e,n,o){function s(){e.isImageUploading=!1,o.currentCategory=e.selectedCategory.name,window.history.back()}if(e.stickersGallery=o,e.isImageUploading=!1,n.categoryId)for(var t=0;t<o.categories.length;t++)if(o.categories[t].id==n.categoryId){e.selectedCategory=o.categories[t];break}e.newImage={url:"null"==n.imageURL?null:n.imageURL},e.addStickerURL=function(){e.newImage.categoryId=e.selectedCategory.id,console.log(e.newImage),e.isImageUploading=!0,o.addStickerURL(e.newImage.categoryId,e.newImage.url).then(function(){s()})},e.addStickerFile=function(){e.newImage.categoryId=e.selectedCategory.id,e.isImageUploading=!0,o.addStickerFile(e.newImage.categoryId,e.newImage.file[0]).then(function(){s()})}}]),angular.module("angControllers").controller("chatController",["user","$scope","$stateParams","$state","api","notification","$timeout","storage","stickersGallery",function(e,n,o,s,t,r,i,a,c){console.log("chat controller is invoked"),n.isStickersGalleryVisiable=!1,n.stickersGallery=c,n.isMessageSending=!1;var l=$(".chat-input");n.scrollToBottom=function(){var e=$(".chat");e.animate({scrollTop:$(".chat")[0].scrollHeight},500)},n.setFocusOnTextField=function(){i(function(){console.log("focus is set on textField"),l.focus()},0),window.device&&"iOS"==device.platform&&i(function(){l.focus(),console.log("focus is set on textField ios")},300)},n.toggleCategory=function(e){n.stickersGallery.currentCategory=n.stickersGallery.currentCategory==e.name?"":e.name,n.isNewCategoryBlockVisible=!1},n.formatMessage=function(e){if(e.match(/(http|https):/)){var n=["gif","png","jpeg","jpg"],o=e.split("."),s=o[o.length-1];return-1!=n.indexOf(s)?"<img src='"+e+"'>":"<a class='message-link' href='"+e+"'>"+e+"</a>"}return e},n.chat=e.chats[o.senderId];var d=n.chat;d.getLastUnexpiredChatSession(),d.isRead||(d.isRead=!0,d.currentUser.saveChats());var g=d.lastUnexpiredChatSession;g||(d.addChatSession(e.uuid,d.senderId),d.getLastUnexpiredChatSession(),g=d.lastUnexpiredChatSession,g.save()),n.chatSession=g,n.isFirstMessage=!n.chatSession.messages.length,n.$watch("chatSession.messages.length",function(){n.scrollToBottom(),d.isRead=!0}),e.friendsList.nepotomFriends[d.senderId]&&r.set(e.friendsList.nepotomFriends[d.senderId].displayName),n.newMessage={text:"",ttl:600,clearText:function(){this.text=""}},n.chatHistory={previousMessages:[],isUpdating:!1,lastVisibleChatSessionId:g.id,isAllChatSessionsVisbile:1==n.chat.chatSessionsIndexes.length?!0:!1,getOneMoreChatSession:function(){var e=this;e.isUpdating=!0;var o=n.chat.chatSessionsIndexes.indexOf(e.lastVisibleChatSessionId),s=n.chat.chatSessionsIndexes[o-1];o-1===0&&(e.isAllChatSessionsVisbile=!0),e.lastVisibleChatSessionId=s,n.chat.getChatSessionFromStorage(s).then(function(n){e.previousMessages=n.messages.concat(e.previousMessages),console.log(e.previousMessages),e.isUpdating=!1})}},n.handleSuccessSending=function(){n.chatSession.messages.length||(n.chatSession.creatorId=e.uuid),n.isFirstMessage=!1,n.errorDescription="",console.log("user:",e)},n.handleFailedSending=function(e){n.errorDescription=e},n.closeErrorDescription=function(){n.errorDescription=""},d.sendMessage=function(){n.setFocusOnTextField(),n.newMessage.text&&(n.isMessageSending=!0,n.chatSession.isReplied||n.chatSession.creatorId!=e.uuid&&n.chatSession.setReplied(),n.chatSession.sendMessage(n.newMessage.text,d.senderId,n.newMessage.ttl).then(function(){n.handleSuccessSending()},function(e){n.handleFailedSending(e)}).then(function(){n.newMessage.clearText(),n.isMessageSending=!1},function(){n.newMessage.clearText(),n.isMessageSending=!1}))},n.sendSticker=function(e){n.newMessage.text=e,n.isStickersGalleryVisiable=!1,d.sendMessage()},n.checkIfEnter=function(e){13===e.keyCode&&d.sendMessage()},n.addStickerURL=function(e){console.log(e),e.isOwn||e.text.match(/(http|https):/)&&(location.href="#/addImage?imageURL="+e.text)},o.messageText&&(n.newMessage.text=o.messageText,d.sendMessage()),$(document).on("webViewShrunk",function(){location.href.match("chat?")&&n.setFocusOnTextField()}),n.setFocusOnTextField(),n.scrollToBottom()}]),angular.module("angControllers").controller("chatsController",["user","$scope","$http","$timeout","api","notification",function(e,n){console.log("chats controller is invoked"),n.$watch("user.chats",function(){if(e){var o=e.chats;for(var s in o)o[s].getLastUnexpiredChatSession();n.user=e}})}]),angular.module("angControllers").controller("exitController",["$scope","$state","user","storage",function(e,n,o){e.exit=function(){o.logout(),n.go("start")}}]),angular.module("angControllers").controller("friendsController",["user","$scope","$stateParams",function(e,n){console.log("friends controller is enabled"),n.user=e,n.isEditMode=!1,n.showAll="0",n.hideKeyboard=function(){console.log("keyboard is hidden"),window.device&&cordova.plugins.Keyboard.close()},n.removeFriend=function(n,o){e.friendsList.removeFriend(o),n.preventDefault()},n.getFriendLink=function(n){var o="#/chat?senderId=",s="#/invitation?friendIndex=";return n.uuid?o+n.uuid:s+e.friendsList.friends.indexOf(n)},e.friendsList.getUserContacts()}]),angular.module("angControllers").controller("friendSearchController",["user","$scope","$http","$state","api",function(e,n,o,s,t){n.showSpinner=!1,n.findUserByName=function(){n.showSpinner=!0,t.searchUser(n.nameToSearch).then(function(e){n.handleSearchResults(e)},function(){console.error("friend search error")}).then(function(){n.showSpinner=!1},function(){n.showSpinner=!1})},n.handleSearchResults=function(o){console.log(o),n.foundUuid="";var s=o.search_results[0];if(s.type)n.canBeAdded=!1,n.serverResponse=s.type;else{if(e.friendsList.nepotomFriends[s.uuid])return n.canBeAdded=!1,void(n.serverResponse="Пользователь уже ваш друг");n.canBeAdded=!0,n.nameToAdd=n.nameToSearch,n.foundUuid=s.uuid}},n.addToFriends=function(){e.chats[n.foundUuid]||e.addChat(n.foundUuid),e.addFriend(n.foundUuid,n.nameToAdd),n.canBeAdded=!1,n.serverResponse="пользователь добавлен",console.log(e)}}]),angular.module("angControllers").controller("invitationController",["user","$scope","$stateParams",function(e,n,o){var s="Привет! Давай общаться в мессенджере nepotom http://linktoapp.com";o.friendIndex&&(n.friend=e.friendsList.friends[+o.friendIndex]),n.inviteViaSms=function(){console.log("invite via sms is called"),window.plugins.socialsharing.shareViaSMS(s,n.friend.phoneNumbers[0].value,function(e){console.log("ok: "+e)},function(e){console.log("error: "+e)})}}]),angular.module("angControllers").controller("localForageController",function(e){function n(e){console.log(e);var n=new FileUploadOptions;n.fileKey="file",n.fileName=e.substr(e.lastIndexOf("/")+1)+".png",n.mimeType="text/plain";var t=new Object;n.params=t;var r=new FileTransfer;r.upload(e,encodeURI("http://some.server.com/upload.php"),o,s,n)}function o(e){console.log("Code = "+e.responseCode),console.log("Response = "+e.response),console.log("Sent = "+e.bytesSent)}function s(e){alert("An error has occurred: Code = "+e.code),console.log("upload error source "+e.source),console.log("upload error target "+e.target)}e.uploadFromGallery=function(){navigator.camera.getPicture(n,function(){alert("get picture failed")},{quality:50,destinationType:navigator.camera.DestinationType.FILE_URI,sourceType:navigator.camera.PictureSourceType.PHOTOLIBRARY})}}),angular.module("angControllers").controller("mainController",["$rootScope","$scope","$http","$location","$state","notification","api","storage","user","ChatSession",function(e,n,o,s,t,r,i,a,c){n.user=c,console.log("main controller is invoked"),e.isAppInBackground=!1,document.addEventListener("pause",function(){e.isAppInBackground=!0,c.saveChats()}),document.addEventListener("resume",function(){e.isAppInBackground=!1}),document.addEventListener("deviceready",function(){"iOS"===device.platform&&$(".iphone-status-bar-margin").show()}),n.openMenu=function(){console.log("swipe open"),window.device&&"iOS"===window.device.platform&&cordova.plugins.Keyboard.close(),$(".off-canvas-wrap").foundation("offcanvas","show","move-right")},n.closeMenu=function(){console.log("swipe close"),$(".off-canvas-wrap").foundation("offcanvas","hide","move-right")},n.$on("$stateChangeStart",function(){r.clear()})}]),angular.module("angControllers").controller("phoneRegistrationController",["user","$scope","$stateParams","$state",function(e,n,o,s){function t(e){for(var n="",o=0;e>o;o++){var s=Math.round(9*Math.random())+48;n+=String.fromCharCode(s)}return console.log(n),n}function r(o){e.confirmPhoneNumber("",o).then(function(){n.showSpinner=!1,n.serverResponse="",s.go("chats")},function(e){i++,i>10?(n.showSpinner=!1,n.serverResponse="Произошла ошибка \n Попробуйте альтернативный способ регистрации",console.log("10 times registration was checked")):setTimeout(r,1e3),console.log(e)})}n.newUser={},n.showSpinner=!1,n.screenToShow="phoneEnter",n.serverResponse="";var i=0;n.initRegistration=function(){n.showSpinner=!0;var o="+"+n.newUser.phone;e.initRegistrationWithPhone(o).then(function(){n.screenToShow="phoneConfirm",n.showSpinner=!1,n.serverResponse=""},function(){n.showSpinner=!1,n.serverResponse="Ошибка. Проверьте правильность номера"})},n.confirmPhoneNumber=function(){n.showSpinner=!0;var o="+"+n.newUser.phone;e.confirmPhoneNumber(o,n.newUser.confirmCode).then(function(){n.showSpinner=!1,n.serverResponse="",s.go("chats")},function(e){n.showSpinner=!1,n.serverResponse="Ошибка. Проверьте правильность кода",console.log(e)})},n.goToEnterPhase=function(){n.screenToShow="phoneEnter"},n.goToAfterSmsSending=function(){n.screenToShow="afterSmsSending",n.showSpinner=!0},n.closeServerResponse=function(){n.serverResponse=""},n.sendSms=function(){n.generatedCode=t(12);var e="pass"+n.generatedCode;window.plugins.socialsharing.shareViaSMS(e,"+14845145060",function(e){n.goToAfterSmsSending(),r(),console.log("ok: "+e)},function(e){console.log("error: "+e)})}}]),angular.module("angControllers").controller("phoneRegistrationUserController",["user","$scope","$stateParams","$state",function(e,n){n.newUser={},n.showSpinner=!1,n.screenToShow="phoneEnter",n.showSuccess=!1,n.serverResponse="",n.attachPhoneNumber=function(){n.showSpinner=!0,n.showSuccess=!1;var o="+"+n.newUser.phone;e.attachPhoneNumber(o).then(function(){n.screenToShow="phoneConfirm",n.showSpinner=!1,n.serverResponse=""},function(e){n.showSpinner=!1,n.serverResponse=e})},n.confirmPhoneNumber=function(){n.showSpinner=!0;var o="+"+n.newUser.phone;e.confirmPhoneNumber(o,n.newUser.confirmCode,!0).then(function(){n.showSpinner=!1,n.showSuccess=!0,n.serverResponse=""},function(e){n.showSpinner=!1,n.serverResponse="Ошибка. Проверьте правильность кода",console.log(e)})},n.attachViaSms=function(){window.plugins.socialsharing.shareViaSMS(e.accessToken,"+14845145060",function(e){console.log("ok: "+e),n.screenToShow="seccessfulSmsSending"},function(e){console.log("error: "+e)})},n.goToEnterPhase=function(){n.screenToShow="phoneEnter"},n.closeServerResponse=function(){n.serverResponse=""}}]),angular.module("angControllers").controller("settingsController",["user","$scope",function(e,n){n.user=e}]),angular.module("angControllers").controller("signinupController",["user","$scope","$state","$stateParams","$q","api","notification","storage",function(e,n,o,s,t,r,i){console.log("sign in is invoked"),n.newUser={},n.showSpinner=!1,n.isIn="in"==s.inOrUp?!0:!1,i.set(n.isIn?"Авторизация":"Регистрация"),n.signin=function(){n.showSpinner=!0,n.serverResponse="",e.signin(n.newUser.name,n.newUser.password).then(function(){n.showSpinner=!1,o.go("friends")},function(e){n.showSpinner=!1,n.serverResponse=e})},n.signup=function(){console.log("sign up is invoked"),n.showSpinner=!0,e.signup(n.newUser.name,n.newUser.password).then(function(){n.signin()},function(e){n.serverResponse=e,n.showSpinner=!1})},n.closeServerResponse=function(){n.serverResponse=!1}}]),angular.module("angControllers").controller("startController",["user","$state",function(e,n){n.go(e.isLogged()?0===Object.keys(e.chats).length?"friends":"chats":"start")}]),angular.module("angControllers").controller("stickersGalleryController",["$scope","stickersGallery","$timeout","$stateParams",function(e,n,o,s){e.stickersGallery=n,e.isNewCategoryBlockVisible=!1,e.isAddingNewCategory=!1,e.fromChat=s.fromChat,e.toggleCategory=function(n){e.stickersGallery.currentCategory=e.stickersGallery.currentCategory==n.name?"":n.name,e.isNewCategoryBlockVisible=!1},e.changeCategoryName=function(e){e.isCategoryNameChanging=!0,e.newName=e.name,o(function(){$("."+e.name+"-input")[0].focus()},301)},e.applyNewName=function(o){o.newName!=o.name&&n.updateCategory(o.id,o.newName),e.cancelNewName(o)},e.cancelNewName=function(e){e.newName="",e.isCategoryNameChanging=!1},e.showNewCategoryBlock=function(){e.isNewCategoryBlockVisible=!0,e.stickersGallery.currentCategory=""},e.hideNewCategoryBlock=function(){e.isNewCategoryBlockVisible=!1,e.newCategoryName=""},e.scrollToLastAddedImage=function(){var e=$("div[overscrollable-without-footer]"),n=$(".activeCategory");if(n.length){var o=n.children(".stickers-gallery-image-wrapper").last().offset().top;e.scrollTop(o)}},e.addNewCategory=function(){e.newCategoryName&&(e.isAddingNewCategory=!0,n.addNewCategory(e.newCategoryName).then(function(){e.isAddingNewCategory=!1},function(){e.isAddingNewCategory=!1}),e.newCategoryName="")},e.removeCategory=function(e){n.removeCategory(e)},e.removeSticker=function(e,o){n.removeSticker(e.id,o.id)},e.changeImageCategory=function(e,n){e.isCategoryChanging=!0,e.newCategoryId=n.id,e.categoryId=n.id},e.applyNewImageCategory=function(o){o.categoryId!=o.newCategoryId&&n.moveSticker(o.categoryId,o.id,o.newCategoryId),e.cancelNewImageCategory(o)},e.cancelNewImageCategory=function(e){e.isCategoryChanging=!1},e.$watch("stickersGallery.isUpdating",function(){e.stickersGallery.isUpdating||o(function(){e.scrollToLastAddedImage()},0)}),e.scrollToLastAddedImage()}]);